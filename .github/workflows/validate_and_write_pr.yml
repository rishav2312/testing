name: Validate PR & Preview input.json

on:
  pull_request_target:
    types: [opened, edited, reopened, closed]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate-preview-write:
    runs-on: ubuntu-latest
    steps:
      - name: Process PR and prepare input.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const REQUIRED_LABELS = [
              "Channels:",
              "Headless:",
              "Business Issue:",
              "Crew Name:",
              "Product Owner Name:",
              "Product Owner Email:",
              "Tech Lead Name:",
              "Tech Lead Email:",
              "Crew Lead Name:",
              "Crew Lead Email:",
              "Team Distribution List Email:",
              "Commando Brief:",
              "Comments:",
              "SPG:"
            ];

            const body = context.payload.pull_request?.body || "";
            const action = context.payload.action;
            const merged = context.payload.pull_request?.merged;

            // parse fields
            const lines = body.split(/\r?\n/);
            const result = {};
            const missing = [];

            function findValue(label) {
              const idx = lines.findIndex(l => l.toLowerCase().includes(label.toLowerCase()));
              if (idx === -1) return null;
              const line = lines[idx];
              const after = line.substring(line.toLowerCase().indexOf(label.toLowerCase()) + label.length).trim();
              if (after) return after;
              for (let i = idx + 1; i < Math.min(lines.length, idx + 5); i++) {
                const c = lines[i].trim();
                if (c) return c;
              }
              return "";
            }

            for (const label of REQUIRED_LABELS) {
              let v = findValue(label);
              if (v === null || v === "") {
                missing.push(label);
                continue;
              }
              v = v.replace(/[*_`>~-]/g, "").replace(/\s+/g, " ").trim();
              v = v.replace(/^NA$/i, "NA").replace(/^\*\*?\s*NA\s*\*\*?$/i, "NA");
              result[label.replace(/:$/, "")] = v;
            }

            const jsonContent = JSON.stringify(result, null, 2);

            // 1Ô∏è‚É£ If PR just opened/edited ‚Äî validate & show preview
            if (!merged) {
              if (missing.length > 0) {
                const msg = [
                  "‚ö†Ô∏è **PR validation failed**",
                  "",
                  "**Missing or empty fields:**",
                  ...missing.map(m => `- ${m}`),
                  "",
                  "Please fill all required fields (or `NA` where not applicable)."
                ].join("\n");

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: msg
                });
                throw new Error("Validation failed");
              }

              const preview = "üßæ **input.json preview:**\n```json\n" + jsonContent + "\n```\n"
                + "‚úÖ All fields validated. This file will be written after merge.";

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: preview
              });

              console.log("Preview posted successfully.");
              return;
            }

            // 2Ô∏è‚É£ If PR merged ‚Äî actually create file/input.json
            if (merged && action === "closed") {
              const path = "file/input.json";
              const msg = `Add/update ${path} from PR #${context.issue.number} by ${context.actor}`;

              let sha;
              try {
                const res = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path
                });
                sha = res.data.sha;
              } catch {}

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: msg,
                content: Buffer.from(jsonContent).toString("base64"),
                sha
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "‚úÖ Merged and wrote `file/input.json` successfully."
              });

              console.log("input.json committed successfully.");
            }
