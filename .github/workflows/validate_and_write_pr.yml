name: Validate PR & Preview input.json

on:
  pull_request_target:
    types: [opened, edited, reopened, closed]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  validate-preview-write:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body fields and write file/input.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const REQUIRED_LABELS = [
              "Channels:",
              "Headless:",
              "Business Issue:",
              "Crew Name:",
              "Product Owner Name:",
              "Product Owner Email:",
              "Tech Lead Name:",
              "Tech Lead Email:",
              "Crew Lead Name:",
              "Crew Lead Email:",
              "Team Distribution List Email:",
              "Commando Brief:",
              "Comments:",
              "SPG:"
            ];

            const pr = context.payload.pull_request;
            const bodyRaw = pr?.body || "";
            const action = context.payload.action;
            const merged = pr?.merged;

            // clean markdown
            const body = bodyRaw
              .replace(/\*\*/g, "")
              .replace(/[_>`~-]/g, "")
              .replace(/\r\n/g, "\n")
              .trim();

            const lines = body.split(/\r?\n/);
            const result = {};
            const missing = [];

            function findValue(label) {
              const idx = lines.findIndex(l => l.toLowerCase().includes(label.toLowerCase()));
              if (idx === -1) return null;
              const line = lines[idx];
              const after = line.substring(line.toLowerCase().indexOf(label.toLowerCase()) + label.length).trim();
              if (after) return after;
              for (let i = idx + 1; i < Math.min(lines.length, idx + 5); i++) {
                const cand = lines[i].trim();
                if (cand) return cand;
              }
              return "";
            }

            for (const label of REQUIRED_LABELS) {
              let value = findValue(label);
              if (value === null) {
                missing.push(label);
                continue;
              }
              value = value.replace(/[*_`>~-]/g, "").trim();
              const isEmpty = value === "";
              // ‚úÖ Accept NA as valid
              const isNA = /^NA$/i.test(value);
              if (isEmpty) {
                missing.push(label);
              } else {
                result[label.replace(/:$/, "")] = value;
              }
            }

            const jsonContent = JSON.stringify(result, null, 2);

            // 1Ô∏è‚É£ Validate and preview
            if (!merged) {
              if (missing.length > 0) {
                const msg = [
                  "‚ö†Ô∏è **PR validation failed**",
                  "",
                  "**Missing (empty) fields:**",
                  ...missing.map(f => `- ${f}`),
                  "",
                  "Please fill all fields (use `NA` if not applicable)."
                ].join("\n");

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: msg
                });

                throw new Error("Validation failed ‚Äî one or more fields empty");
              }

              const preview = "üßæ **input.json preview:**\n```json\n" + jsonContent + "\n```\n‚úÖ All fields validated (NA accepted).";
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: preview
              });
              console.log("Preview posted successfully.");
              return;
            }

            // 2Ô∏è‚É£ On merge ‚Üí write file/input.json
            if (merged && action === "closed") {
              const path = "file/input.json";
              const msg = `Add/update ${path} from PR #${context.issue.number} by ${context.actor}`;

              let sha;
              try {
                const res = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path
                });
                sha = res.data.sha;
              } catch {}

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
                message: msg,
                content: Buffer.from(jsonContent).toString("base64"),
                sha
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "‚úÖ PR merged ‚Äî `file/input.json` created successfully."
              });
            }
