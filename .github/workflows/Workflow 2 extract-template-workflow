name: Extract Template and Generate Input.json

on:
  pull_request_target:
    branches: [ github_actions ]
    types: [closed]

permissions:
  contents: write  # Required to commit the new JSON files back to the repo
  pull-requests: read

jobs:
  extract-and-generate:
    # Only run if the PR was actually merged (not just closed without merging)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main # Ensure we are on the main branch to push changes
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            businessConfig/**

      - name: Determine affected directories
        id: affected-dirs
        uses: actions/github-script@v7
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          script: |
            const changedFiles = process.env.CHANGED_FILES.split(' ').filter(f => f.trim());
            
            if (changedFiles.length === 0) {
              core.warning('No businessConfig files changed');
              return;
            }
            
            // Extract all unique second-level directories
            const directories = new Set();
            for (const file of changedFiles) {
              const match = file.match(/^businessConfig\/([^\/]+)\//);
              if (match) {
                directories.add(match[1]);
              }
            }
            
            if (directories.size === 0) {
              core.warning('Could not determine target directories from changed files');
              core.setOutput('target-dirs', '');
              return;
            }
            
            const dirArray = Array.from(directories).sort();
            core.setOutput('target-dirs', dirArray.join(','));
            core.info(`Affected directories: ${dirArray.join(', ')}`);

      - name: Extract template and create input.json files
        id: extract
        uses: actions/github-script@v7
        # Direct access to PR Body via event payload - No complex API calls needed!
        env:
          PR_DESCRIPTION: ${{ github.event.pull_request.body }}
          TARGET_DIRS: ${{ steps.affected-dirs.outputs.target-dirs }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const prDescription = process.env.PR_DESCRIPTION || '';
            const targetDirsStr = process.env.TARGET_DIRS;
            
            if (!targetDirsStr) {
               core.warning('No target directories to process');
               return;
            }

            const targetDirs = targetDirsStr.split(',').filter(d => d.trim());
            
            // 1. Define Mapping
            const fieldMapping = {
              'Channels': 'channels',
              'Headless': 'headless',
              'Business Issue': 'businessIssue',
              'Crew Name': 'crewName',
              'Product Owner Name': 'productOwnerName',
              'Product Owner Email': 'productOwnerEmail',
              'Tech Lead Name': 'techLeadName',
              'Tech Lead Email': 'techLeadEmail',
              'Crew Lead Name': 'crewLeadName',
              'Crew Lead Email': 'crewLeadEmail',
              'Team Distribution List Email': 'teamDistributionListEmail',
              'Commando Brief': 'commandoBrief',
              'Comments': 'comments',
              'SPG': 'spg'
            };
            
            const templateData = {};
            // Initialize empty
            Object.values(fieldMapping).forEach(field => templateData[field] = '');

            // 2. Parse Description
            const lines = prDescription.split('\n');
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              const match = line.match(/^(?:\*\*)?([^*:]+?)(?:\*\*)?\s*:\s*(.*)/);
              
              if (match) {
                const fieldName = match[1].trim();
                const jsonFieldName = fieldMapping[fieldName];
                
                if (jsonFieldName) {
                  let fieldValue = match[2].trim();
                  let j = i + 1;
                  while (j < lines.length) {
                    const nextLine = lines[j];
                    if (nextLine.match(/^(?:\*\*)?[^*:]+?(?:\*\*)?\s*:/)) break;
                    const trimmedLine = nextLine.trim();
                    if (trimmedLine) fieldValue += (fieldValue ? '\n' : '') + trimmedLine;
                    j++;
                  }
                  templateData[jsonFieldName] = fieldValue;
                }
              }
            }
            
            core.info(`Extracted Data: ${JSON.stringify(templateData, null, 2)}`);
            
            // 3. Write Files
            const createdFiles = [];
            for (const dir of targetDirs) {
              const targetPath = `businessConfig/${dir.trim()}`;
              const inputJsonPath = path.join(targetPath, 'input.json');
              
              if (!fs.existsSync(targetPath)) {
                fs.mkdirSync(targetPath, { recursive: true });
              }
              
              fs.writeFileSync(inputJsonPath, JSON.stringify(templateData, null, 2));
              createdFiles.push(inputJsonPath);
              core.info(`Created ${inputJsonPath}`);
            }

      - name: Commit and push changes
        if: steps.affected-dirs.outputs.target-dirs != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add businessConfig/**/input.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-generate input.json from PR #${{ github.event.pull_request.number }}"
            git push origin main
            echo "âœ… Successfully committed and pushed input.json files"
          fi
