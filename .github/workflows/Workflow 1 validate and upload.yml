name: Validate PR Template

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-template:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Template Fields
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const requiredFields = [
              'Channels',
              'Headless',
              'Business Issue',
              'Crew Name',
              'Product Owner Name',
              'Product Owner Email',
              'Tech Lead Name',
              'Tech Lead Email',
              'Crew Lead Name',
              'Crew Lead Email',
              'Team Distribution List Email',
              'Commando Brief',
              'Comments',
              'SPG'
            ];
            
            const body = context.payload.pull_request.body || '';
            const fieldValues = {};
            const lines = body.split('\n');
            
            // Parse template fields
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              const match = line.match(/^\*\*([^*]+)\*\*:\s*(.*)/);
              
              if (match) {
                const fieldName = match[1].trim();
                let fieldValue = match[2].trim();
                
                // For multi-line fields, collect subsequent lines until next field
                let j = i + 1;
                while (j < lines.length && !lines[j].match(/^\*\*/)) {
                  const nextLine = lines[j].trim();
                  if (nextLine) {
                    fieldValue += '\n' + nextLine;
                  }
                  j++;
                }
                
                fieldValues[fieldName] = fieldValue;
              }
            }
            
            // Validate fields
            const validationResults = [];
            const missingFields = [];
            
            for (const field of requiredFields) {
              const value = fieldValues[field] || '';
              const isEmpty = !value || value.trim() === '';
              const isNA = value.trim().toLowerCase() === 'na';
              const isValid = !isEmpty || isNA;
              
              if (isValid) {
                validationResults.push(`✅ **${field}**: Filled`);
              } else {
                validationResults.push(`❌ **${field}**: EMPTY`);
                missingFields.push(field);
              }
            }
            
            // Create comment
            const comment = `## PR Template Validation Results\n\n${validationResults.join('\n')}\n\n${missingFields.length > 0 ? `### ⚠️ Missing Fields\n${missingFields.map(f => \`- \${f}\`).join('\n')}\n\nPlease fill all required fields before merging.` : '### ✅ All fields are valid!'}`;
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Store results for next step
            core.setOutput('validation-passed', missingFields.length === 0);
            core.setOutput('missing-fields', missingFields.join(', '));
            
            if (missingFields.length > 0) {
              core.setFailed(`Validation failed. Missing fields: ${missingFields.join(', ')}`);
            }
