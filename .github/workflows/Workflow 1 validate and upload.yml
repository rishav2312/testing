name: Validate PR Template

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-template:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Template Fields
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const requiredFields = [
              'Channels',
              'Headless',
              'Business Issue',
              'Crew Name',
              'Product Owner Name',
              'Product Owner Email',
              'Tech Lead Name',
              'Tech Lead Email',
              'Crew Lead Name',
              'Crew Lead Email',
              'Team Distribution List Email',
              'Commando Brief',
              'Comments',
              'SPG'
            ];
            
            const body = context.payload.pull_request.body || '';
            const fieldValues = {};
            const lines = body.split('\n');
            
            // Parse template fields (works with plain text format like "Channels: value")
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              // Match both "**Field**:" and "Field:" formats
              const match = line.match(/^(?:\*\*)?([^*:]+?)(?:\*\*)?\s*:\s*(.*)/);
              
              if (match) {
                const fieldName = match[1].trim();
                let fieldValue = match[2].trim();
                
                // Check if this is a known field
                const isKnownField = requiredFields.includes(fieldName);
                
                if (isKnownField) {
                  // For multi-line fields, collect subsequent lines until next field
                  let j = i + 1;
                  while (j < lines.length) {
                    const nextLine = lines[j];
                    // Stop if we hit another field (contains ":")
                    if (nextLine.match(/^(?:\*\*)?[^*:]+?(?:\*\*)?\s*:/)) {
                      break;
                    }
                    const trimmedLine = nextLine.trim();
                    if (trimmedLine) {
                      fieldValue += '\n' + trimmedLine;
                    }
                    j++;
                  }
                  
                  fieldValues[fieldName] = fieldValue;
                }
              }
            }
            
            // Validate fields
            const validationResults = [];
            const missingFields = [];
            
            for (const field of requiredFields) {
              const value = fieldValues[field] || '';
              const isEmpty = !value || value.trim() === '';
              const isNA = value.trim().toLowerCase() === 'na';
              const isValid = !isEmpty || isNA;
              
              if (isValid) {
                validationResults.push(`✅ **${field}**: Filled`);
              } else {
                validationResults.push(`❌ **${field}**: EMPTY`);
                missingFields.push(field);
              }
            }
            
            // Store results
            core.setOutput('validation-passed', missingFields.length === 0);
            core.setOutput('missing-fields', missingFields.join(', '));
            
            // Log validation results
            console.log('Validation Results:');
            validationResults.forEach(result => console.log(result));
            
            if (missingFields.length > 0) {
              console.log('\n❌ Missing Fields:');
              missingFields.forEach(field => console.log(`  - ${field}`));
              core.setFailed(`Validation failed. Missing fields: ${missingFields.join(', ')}`);
            } else {
              console.log('\n✅ All fields are valid!');
            }
