name: Workflow 2 - Create Metadata Branch on PR Merge

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'pr-template/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-metadata-branch:
    name: Create Metadata Branch After Merge
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Get merge commit information
        id: merge-info
        run: |
          echo "=== Merge Commit Information ==="
          
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%ai)
          
          echo "Commit SHA: $COMMIT_SHA"
          echo "Commit Author: $COMMIT_AUTHOR"
          echo "Commit Date: $COMMIT_DATE"
          
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit_author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          PR_NUM=$(echo "$COMMIT_MSG" | grep -oP 'pull request #\K[0-9]+' || echo "")
          
          if [ -z "$PR_NUM" ]; then
            PR_NUM=$(echo "$COMMIT_MSG" | grep -oP '\(#\K[0-9]+' || echo "")
          fi
          
          echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
          
          if [ -z "$PR_NUM" ]; then
            echo "‚ö†Ô∏è  Could not extract PR number from commit message"
          else
            echo "‚úì Extracted PR number: $PR_NUM"
          fi
      
      - name: Verify template files were modified
        id: verify-files
        run: |
          echo "=== Verifying Template Files ==="
          
          CHANGED_FILES=$(git diff HEAD~1 HEAD --name-only)
          
          echo "Changed files in this merge:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q "^pr-template/"; then
            echo "template_modified=true" >> $GITHUB_OUTPUT
            echo "‚úì PR template files were modified"
          else
            echo "template_modified=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No PR template files were modified"
            exit 0
          fi
          
          required_files=(
            "pr-template/project-config.yml"
            "pr-template/table-metadata.yml"
            "pr-template/maintenance-config.yml"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì File exists: $file"
            else
              echo "‚ö†Ô∏è  File not found: $file (optional)"
            fi
          done
      
      - name: Setup Java
        if: steps.verify-files.outputs.template_modified == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      
      - name: Setup Git configuration
        run: |
          git config --global user.email "github-actions@target.com"
          git config --global user.name "GitHub Actions Bot"
          echo "‚úì Git configured"
      
      - name: Extract and validate template data
        if: steps.verify-files.outputs.template_modified == 'true'
        id: extract-data
        run: |
          echo "=== Extracting Template Data ==="
          
          if [ -f "pr-template/project-config.yml" ]; then
            PROJECT_NAME=$(grep "^project_name:" pr-template/project-config.yml | cut -d' ' -f2- | sed "s/'//g" | sed 's/"//g')
            PROJECT_LOCATION=$(grep "^project_location:" pr-template/project-config.yml | cut -d' ' -f2- | sed "s/'//g" | sed 's/"//g')
            
            echo "Project Name: $PROJECT_NAME"
            echo "Project Location: $PROJECT_LOCATION"
            
            echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
            echo "project_location=${PROJECT_LOCATION}" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "pr-template/table-metadata.yml" ]; then
            TABLE_NAME=$(grep "^table_name:" pr-template/table-metadata.yml | cut -d' ' -f2- | sed "s/'//g" | sed 's/"//g')
            TABLE_TYPE=$(grep "^table_type:" pr-template/table-metadata.yml | cut -d' ' -f2- | sed "s/'//g" | sed 's/"//g')
            BQ_DATASET=$(grep "^bq_dataset:" pr-template/table-metadata.yml | cut -d' ' -f2- | sed "s/'//g" | sed 's/"//g')
            
            echo "Table Name: $TABLE_NAME"
            echo "Table Type: $TABLE_TYPE"
            echo "BQ Dataset: $BQ_DATASET"
            
            echo "table_name=${TABLE_NAME}" >> $GITHUB_OUTPUT
            echo "table_type=${TABLE_TYPE}" >> $GITHUB_OUTPUT
            echo "bq_dataset=${BQ_DATASET}" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "pr-template/maintenance-config.yml" ]; then
            ORPHANS_TTL=$(grep "^orphans_ttl:" pr-template/maintenance-config.yml | cut -d' ' -f2-)
            SNAPSHOTS_TTL=$(grep "^snapshots_ttl:" pr-template/maintenance-config.yml | cut -d' ' -f2-)
            MIN_FILES=$(grep "^min_files_input:" pr-template/maintenance-config.yml | cut -d' ' -f2-)
            
            echo "Orphans TTL: $ORPHANS_TTL"
            echo "Snapshots TTL: $SNAPSHOTS_TTL"
            echo "Min Files Input: $MIN_FILES"
            
            echo "orphans_ttl=${ORPHANS_TTL}" >> $GITHUB_OUTPUT
            echo "snapshots_ttl=${SNAPSHOTS_TTL}" >> $GITHUB_OUTPUT
            echo "min_files_input=${MIN_FILES}" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úì Data extraction completed"
      
      - name: Create metadata branch
        if: steps.verify-files.outputs.template_modified == 'true'
        id: create-branch
        run: |
          echo "=== Creating Metadata Branch ==="
          
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="iceflow/metadata-${TIMESTAMP}"
          
          echo "Branch name: $BRANCH_NAME"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          
          if git rev-parse --verify origin/${BRANCH_NAME} >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Branch already exists, using unique name"
            NANOS=$(date +%N | cut -c1-3)
            BRANCH_NAME="iceflow/metadata-${TIMESTAMP}-${NANOS}"
            echo "Updated branch name: $BRANCH_NAME"
            echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          fi
          
          git checkout -b $BRANCH_NAME
          echo "‚úì Created branch: $BRANCH_NAME"
      
      - name: Generate metadata JSON
        if: steps.verify-files.outputs.template_modified == 'true'
        id: generate-metadata
        run: |
          echo "=== Generating Metadata JSON ==="
          
          cat > metadata.json <<'JSON_EOF'
{
  "metadata": {
    "version": "1.0",
    "generatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "generatedBy": "GitHub Actions - Workflow 2",
    "sourceRepository": "${{ github.repository }}"
  },
  "mergeInfo": {
    "commitSha": "${{ steps.merge-info.outputs.commit_sha }}",
    "commitAuthor": "${{ steps.merge-info.outputs.commit_author }}",
    "commitDate": "${{ steps.merge-info.outputs.commit_date }}",
    "prNumber": "${{ steps.merge-info.outputs.pr_number }}",
    "mainBranch": "${{ github.ref }}"
  },
  "projectConfig": {
    "projectName": "${{ steps.extract-data.outputs.project_name }}",
    "projectLocation": "${{ steps.extract-data.outputs.project_location }}"
  },
  "tableMetadata": {
    "tableName": "${{ steps.extract-data.outputs.table_name }}",
    "tableType": "${{ steps.extract-data.outputs.table_type }}",
    "bqDataset": "${{ steps.extract-data.outputs.bq_dataset }}"
  },
  "maintenanceConfig": {
    "orphansTtl": ${{ steps.extract-data.outputs.orphans_ttl }},
    "snapshotsTtl": ${{ steps.extract-data.outputs.snapshots_ttl }},
    "minFilesInput": ${{ steps.extract-data.outputs.min_files_input }}
  },
  "approvalStatus": {
    "status": "APPROVED",
    "mergedToMain": true,
    "readyForDeployment": true
  }
}
JSON_EOF
          
          sed -i "s|\$(date -u +%Y-%m-%dT%H:%M:%SZ)|$(date -u +%Y-%m-%dT%H:%M:%SZ)|g" metadata.json
          
          echo "‚úì Generated metadata.json"
          echo ""
          echo "=== Metadata Content ==="
          cat metadata.json
          echo ""
      
      - name: Validate generated JSON
        if: steps.verify-files.outputs.template_modified == 'true'
        run: |
          echo "=== Validating Generated JSON ==="
          
          sudo apt-get install -y jq --quiet
          
          if jq empty metadata.json 2>/dev/null; then
            echo "‚úì JSON syntax is valid"
          else
            echo "‚ùå Invalid JSON syntax"
            exit 1
          fi
          
          required_fields=(
            ".metadata.version"
            ".metadata.generatedAt"
            ".mergeInfo.commitSha"
            ".projectConfig.projectName"
            ".tableMetadata.tableName"
            ".approvalStatus.status"
          )
          
          for field in "${required_fields[@]}"; do
            if jq -e "$field" metadata.json >/dev/null 2>&1; then
              value=$(jq -r "$field" metadata.json)
              echo "‚úì $field: $value"
            else
              echo "‚ùå Missing field: $field"
              exit 1
            fi
          done
          
          echo "‚úì All required fields present"
      
      - name: Commit metadata file
        if: steps.verify-files.outputs.template_modified == 'true'
        run: |
          echo "=== Committing Metadata ==="
          
          git add metadata.json
          
          COMMIT_MSG="feat: Add metadata from merged PR #${{ steps.merge-info.outputs.pr_number }}"
          
          if [ -z "${{ steps.merge-info.outputs.pr_number }}" ]; then
            COMMIT_MSG="feat: Add metadata from merged commit ${{ steps.merge-info.outputs.commit_sha }}"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          echo "‚úì Committed metadata file"
          
          echo ""
          echo "Commit details:"
          git log -1 --oneline
      
      - name: Push metadata branch
        if: steps.verify-files.outputs.template_modified == 'true'
        id: push-branch
        run: |
          echo "=== Pushing Metadata Branch ==="
          
          git push origin ${{ steps.create-branch.outputs.branch_name }}
          
          if [ $? -eq 0 ]; then
            echo "‚úì Successfully pushed branch: ${{ steps.create-branch.outputs.branch_name }}"
            echo "push_successful=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to push branch"
            echo "push_successful=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Create pull request for metadata branch
        if: steps.verify-files.outputs.template_modified == 'true' && steps.push-branch.outputs.push_successful == 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìä Auto-generated Metadata from Merged PR #${{ steps.merge-info.outputs.pr_number }}',
              head: '${{ steps.create-branch.outputs.branch_name }}',
              base: 'main',
              body: `## Metadata Update

This PR contains auto-generated metadata from a merged PR.

### Source Information
- **PR Number**: #${{ steps.merge-info.outputs.pr_number }}
- **Commit SHA**: \`${{ steps.merge-info.outputs.commit_sha }}\`
- **Commit Author**: ${{ steps.merge-info.outputs.commit_author }}
- **Merge Date**: ${{ steps.merge-info.outputs.commit_date }}

### Contents
- \`metadata.json\` - Extracted metadata in JSON format

### Approval Status
- ‚úÖ Source PR was approved and merged
- ‚úÖ Metadata was automatically generated
- ‚úÖ Ready for review and merge

### Next Steps
1. Review the metadata.json file
2. If correct, merge this PR
3. If changes needed, request changes

---
*Generated automatically by Workflow 2 on PR merge*`,
              draft: false
            });
            
            console.log('‚úì Created PR: ' + result.data.html_url);
            console.log('PR Number: ' + result.data.number);
      
      - name: Comment on original PR (if PR number found)
        if: steps.verify-files.outputs.template_modified == 'true' && steps.push-branch.outputs.push_successful == 'true' && steps.merge-info.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.merge-info.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Workflow 2 Completed**

Your PR has been merged and Workflow 2 has automatically:

1. ‚úì Created metadata branch: \`${{ steps.create-branch.outputs.branch_name }}\`
2. ‚úì Generated \`metadata.json\` from your template
3. ‚úì Pushed changes to the metadata branch
4. ‚úì Created a new PR for metadata review

**Metadata PR**: #[check the latest PR in the repo]

The metadata is now ready for review. Once the metadata PR is merged, your changes will be fully processed.`
            });
      
      - name: Generate summary report
        if: always() && steps.verify-files.outputs.template_modified == 'true'
        run: |
          echo "=== Workflow 2 Summary Report ==="
          echo ""
          echo "**Status**: ${{ job.status }}"
          echo "**Branch Created**: ${{ steps.create-branch.outputs.branch_name }}"
          echo "**Metadata Generated**: Yes"
          echo "**Files Pushed**: ‚úì"
          echo ""
          echo "**Project Info**:"
          echo "  - Name: ${{ steps.extract-data.outputs.project_name }}"
          echo "  - Location: ${{ steps.extract-data.outputs.project_location }}"
          echo ""
          echo "**Table Info**:"
          echo "  - Name: ${{ steps.extract-data.outputs.table_name }}"
          echo "  - Type: ${{ steps.extract-data.outputs.table_type }}"
          echo "  - Dataset: ${{ steps.extract-data.outputs.bq_dataset }}"
          echo ""
          echo "**Maintenance Config**:"
          echo "  - Orphans TTL: ${{ steps.extract-data.outputs.orphans_ttl }} hours"
          echo "  - Snapshots TTL: ${{ steps.extract-data.outputs.snapshots_ttl }} hours"
          echo "  - Min Files Input: ${{ steps.extract-data.outputs.min_files_input }}"
          echo ""
      
      - name: Notify on success
        if: success() && steps.verify-files.outputs.template_modified == 'true'
        run: |
          echo "‚úÖ Workflow 2 completed successfully!"
          echo ""
          echo "Metadata branch created and pushed."
          echo "A new PR was created for metadata review."
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Workflow 2 failed!"
          echo ""
          echo "Please check the logs above for details."

  cleanup-old-branches:
    name: Cleanup Old Metadata Branches
    needs: create-metadata-branch
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: List old metadata branches
        run: |
          echo "=== Listing Metadata Branches ==="
          
          git branch -r | grep "iceflow/metadata" | sort
      
      - name: Cleanup branches older than 30 days
        run: |
          echo "=== Cleaning up old branches (30+ days) ==="
          echo "‚ÑπÔ∏è  Skipping automatic cleanup (optional feature)"
